{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-10 mx-auto">
        <h2 class="mb-4">
            {{ get_localized_text('GameResultsTable', 'Game Results') }}
        </h2>

        {% if games %}
        <div class="table-responsive">
            <table class="table table-dark table-hover">
                <thead>
                    <tr>
                        <th>{{ get_localized_text('GameResultsTableGameCode', 'Game Code') }}</th>
                        <th>{{ get_localized_text('GameResultsTablePlayers', 'Players') }}</th>
                        <th>{{ get_localized_text('GameResultsTablePutts', 'Total Putts') }}</th>
                        <th>{{ get_localized_text('GameResultsTableRank', 'Ranking') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for game in games %}
                    <tr>
                        <td><code class="bg-dark">{{ game.game_code }}</code></td>
                        <td>
                            {% for player_game in game.players %}
                            <div>{{ player_game.player.name }}</div>
                            {% endfor %}
                        </td>
                        <td>
                            {% for player_game in game.players %}
                            <div>{{ player_game.total_score }}</div>
                            {% endfor %}
                        </td>
                        <td>
                            {% set sorted_players = game.players|sort(attribute='total_score') %}
                            {% for player_game in sorted_players %}
                            <div>
                                {{ loop.index }}: {{ player_game.player.name }}
                            </div>
                            {% endfor %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Outstanding Achievements Section -->
        <h3 class="mt-5 mb-4">{{ get_localized_text('OutstandingAchievementsTableTitle', 'Outstanding Achievements') }}</h3>
        <div class="table-responsive">
            <table class="table table-dark table-hover">
                <thead>
                    <tr>
                        <th>{{ get_localized_text('OutstandingAchievementsTableCol1', 'Achievement') }}</th>
                        <th>{{ get_localized_text('OutstandingAchievementsTableCol2', 'Player') }}</th>
                        <th>{{ get_localized_text('OutstandingAchievementsTableCol3', 'Details') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% set all_achievements = {
                        'holes_in_one': [],
                        'birdies': [],
                        'eagles': [],
                        'albatrosses': [],
                        'condors': [],
                        'holes_in_par': []
                    } %}

                    {% for game in games %}
                        {% for player_game in game.players %}
                            {% set achievements = {
                                'holes_in_one': [],
                                'birdies': [],
                                'eagles': [],
                                'albatrosses': [],
                                'condors': [],
                                'holes_in_par': []
                            } %}

                            {% for score in player_game.scores %}
                                {% set hole = game.course.holes|sort(attribute='name')|list %}
                                {% if score.hole_number <= hole|length %}
                                    {% set current_hole = hole[score.hole_number - 1] %}

                                    {% if score.strokes == 1 %}
                                        {% set achievements.holes_in_one = achievements.holes_in_one + [score.hole_number] %}
                                    {% endif %}

                                    {% if score.strokes == current_hole.par - 1 %}
                                        {% set achievements.birdies = achievements.birdies + [score.hole_number] %}
                                    {% endif %}

                                    {% if score.strokes == current_hole.par - 2 %}
                                        {% set achievements.eagles = achievements.eagles + [score.hole_number] %}
                                    {% endif %}

                                    {% if score.strokes == current_hole.par - 3 %}
                                        {% set achievements.albatrosses = achievements.albatrosses + [score.hole_number] %}
                                    {% endif %}

                                    {% if score.strokes == current_hole.par - 4 %}
                                        {% set achievements.condors = achievements.condors + [score.hole_number] %}
                                    {% endif %}

                                    {% if score.strokes == current_hole.par %}
                                        {% set achievements.holes_in_par = achievements.holes_in_par + [score.hole_number] %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}

                            {% if achievements.holes_in_one %}
                                {% set all_achievements.holes_in_one = all_achievements.holes_in_one + achievements.holes_in_one %}
                            {% endif %}

                            {% if achievements.birdies %}
                                {% set all_achievements.birdies = all_achievements.birdies + achievements.birdies %}
                            {% endif %}

                            {% if achievements.eagles %}
                                {% set all_achievements.eagles = all_achievements.eagles + achievements.eagles %}
                            {% endif %}

                            {% if achievements.albatrosses %}
                                {% set all_achievements.albatrosses = all_achievements.albatrosses + achievements.albatrosses %}
                            {% endif %}

                            {% if achievements.condors %}
                                {% set all_achievements.condors = all_achievements.condors + achievements.condors %}
                            {% endif %}

                            {% if achievements.holes_in_par %}
                                {% set all_achievements.holes_in_par = all_achievements.holes_in_par + achievements.holes_in_par %}
                            {% endif %}
                        {% endfor %}
                    {% endfor %}

                    {% if all_achievements.holes_in_one %}
                        {% set max_holes_in_one = all_achievements.holes_in_one|count %}
                        {% for player_name, data in all_achievements.holes_in_one.items() %}
                            {% if data.count == max_holes_in_one %}
                                <tr>
                                    <td>Most Holes in One</td>
                                    <td>{{ player_name }}</td>
                                    <td>{{ player_name }} scored {{ data.count }} holes in one on holes {{ data.holes|join(', ') }}!</td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                    {% endif %}


                    {% if all_achievements.birdies %}
                        {% set max_birdies = all_achievements.birdies|count %}
                        {% for player_name, data in all_achievements.birdies.items() %}
                            {% if data.count == max_birdies %}
                                <tr>
                                    <td>Most Birdies</td>
                                    <td>{{ player_name }}</td>
                                    <td>{{ player_name }} scored {{ data.count }} birdies on holes {{ data.holes|join(', ') }}!</td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                    {% endif %}

                    {% if all_achievements.eagles %}
                        {% set max_eagles = all_achievements.eagles|count %}
                        {% for player_name, data in all_achievements.eagles.items() %}
                            {% if data.count == max_eagles %}
                                <tr>
                                    <td>Most Eagles</td>
                                    <td>{{ player_name }}</td>
                                    <td>{{ player_name }} scored {{ data.count }} eagles on holes {{ data.holes|join(', ') }}!</td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                    {% endif %}

                    {% if all_achievements.albatrosses %}
                        {% set max_albatrosses = all_achievements.albatrosses|count %}
                        {% for player_name, data in all_achievements.albatrosses.items() %}
                            {% if data.count == max_albatrosses %}
                                <tr>
                                    <td>Most Albatrosses</td>
                                    <td>{{ player_name }}</td>
                                    <td>{{ player_name }} scored {{ data.count }} albatrosses on holes {{ data.holes|join(', ') }}!</td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                    {% endif %}

                    {% if all_achievements.condors %}
                        {% set max_condors = all_achievements.condors|count %}
                        {% for player_name, data in all_achievements.condors.items() %}
                            {% if data.count == max_condors %}
                                <tr>
                                    <td>Most Condors</td>
                                    <td>{{ player_name }}</td>
                                    <td>{{ player_name }} scored {{ data.count }} condors on holes {{ data.holes|join(', ') }}!</td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                    {% endif %}

                    {% if all_achievements.holes_in_par %}
                        {% set max_holes_in_par = all_achievements.holes_in_par|count %}
                        {% for player_name, data in all_achievements.holes_in_par.items() %}
                            {% if data.count == max_holes_in_par %}
                                <tr>
                                    <td>Most Holes in Par</td>
                                    <td>{{ player_name }}</td>
                                    <td>{{ player_name }} scored {{ data.count }} holes in par on holes {{ data.holes|join(', ') }}!</td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                </tbody>
            </table>
        </div>

        <!-- Player Stats - the Highs and Lows Section -->
        <h3 class="mt-5 mb-4">Player Stats - the Highs and Lows!</h3>
        <div class="table-responsive">
            <table class="table table-dark table-hover">
                <thead>
                    <tr>
                        <th>Stat</th>
                        <th>Description</th>
                        <th>Player</th>
                    </tr>
                </thead>
                <tbody>
                    {% set player_over_par_counts = {} %}

                    {% for game in games %}
                        {% for player_game in game.players %}
                            {% set over_par_holes = [] %}

                            {% for score in player_game.scores %}
                                {% set hole = game.course.holes|sort(attribute='name')|list %}
                                {% if score.hole_number <= hole|length %}
                                    {% set current_hole = hole[score.hole_number - 1] %}
                                    {% if score.strokes > current_hole.par %}
                                        {% set over_par_holes = over_par_holes + [score.hole_number] %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}

                            {% if player_game.player.name not in player_over_par_counts %}
                                {% set player_over_par_counts = player_over_par_counts | merge({
                                    player_game.player.name: {
                                        'count': over_par_holes|length,
                                        'holes': over_par_holes|sort
                                    }
                                }) %}
                            {% else %}
                                {% set existing_count = player_over_par_counts[player_game.player.name]['count'] %}
                                {% set existing_holes = player_over_par_counts[player_game.player.name]['holes']|list %}
                                {% set player_over_par_counts = player_over_par_counts | merge({
                                    player_game.player.name: {
                                        'count': existing_count + over_par_holes|length,
                                        'holes': (existing_holes + over_par_holes)|sort|unique|list
                                    }
                                }) %}
                            {% endif %}
                        {% endfor %}
                    {% endfor %}

                    {% if player_over_par_counts %}
                        {% set max_over_par = player_over_par_counts.values()|map(attribute='count')|max %}
                        <tr>
                            <td>The Bogey Master</td>
                            <td>The player with the most holes played over par</td>
                            <td>
                                {% for player_name, data in player_over_par_counts.items() %}
                                    {% if data.count == max_over_par %}
                                        {{ player_name }} ({{ data.count }} holes over par)<br>
                                    {% endif %}
                                {% endfor %}
                            </td>
                        </tr>
                    {% endif %}

                    {# Track Holes in One #}
                    {% set player_aces = {} %}

                    {% for game in games %}
                        {% for player_game in game.players %}
                            {% set ace_holes = [] %}

                            {% for score in player_game.scores %}
                                {% if score.strokes == 1 %}
                                    {% set ace_holes = ace_holes + [score.hole_number] %}
                                {% endif %}
                            {% endfor %}

                            {% if player_game.player.name not in player_aces %}
                                {% set player_aces = player_aces | merge({
                                    player_game.player.name: {
                                        'count': ace_holes|length,
                                        'holes': ace_holes|sort
                                    }
                                }) %}
                            {% else %}
                                {% set existing_count = player_aces[player_game.player.name]['count'] %}
                                {% set existing_holes = player_aces[player_game.player.name]['holes']|list %}
                                {% set player_aces = player_aces | merge({
                                    player_game.player.name: {
                                        'count': existing_count + ace_holes|length,
                                        'holes': (existing_holes + ace_holes)|sort|unique|list
                                    }
                                }) %}
                            {% endif %}
                        {% endfor %}
                    {% endfor %}

                    {% if player_aces %}
                        {% set max_aces = player_aces.values()|map(attribute='count')|max %}
                        <tr>
                            <td>The ACE!</td>
                            <td>The player with the most holes in one</td>
                            <td>
                                {% for player_name, data in player_aces.items() %}
                                    {% if data.count == max_aces %}
                                        {{ player_name }} ({{ data.count }} holes in one)<br>
                                    {% endif %}
                                {% endfor %}
                            </td>
                        </tr>
                    {% endif %}

                    {# Track Holes in Par #}
                    {% set player_pars = {} %}

                    {% for game in games %}
                        {% for player_game in game.players %}
                            {% set par_holes = [] %}

                            {% for score in player_game.scores %}
                                {% set hole = game.course.holes|sort(attribute='name')|list %}
                                {% if score.hole_number <= hole|length %}
                                    {% set current_hole = hole[score.hole_number - 1] %}
                                    {% if score.strokes == current_hole.par %}
                                        {% set par_holes = par_holes + [score.hole_number] %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}

                            {% if player_game.player.name not in player_pars %}
                                {% set player_pars = player_pars | merge({
                                    player_game.player.name: {
                                        'count': par_holes|length,
                                        'holes': par_holes|sort
                                    }
                                }) %}
                            {% else %}
                                {% set existing_count = player_pars[player_game.player.name]['count'] %}
                                {% set existing_holes = player_pars[player_game.player.name]['holes']|list %}
                                {% set player_pars = player_pars | merge({
                                    player_game.player.name: {
                                        'count': existing_count + par_holes|length,
                                        'holes': (existing_holes + par_holes)|sort|unique|list
                                    }
                                }) %}
                            {% endif %}
                        {% endfor %}
                    {% endfor %}

                    {% if player_pars %}
                        {% set max_pars = player_pars.values()|map(attribute='count')|max %}
                        <tr>
                            <td>Par-boiled!</td>
                            <td>The player with the most holes putted in par</td>
                            <td>
                                {% for player_name, data in player_pars.items() %}
                                    {% if data.count == max_pars %}
                                        {{ player_name }} ({{ data.count }} holes in par)<br>
                                    {% endif %}
                                {% endfor %}
                            </td>
                        </tr>
                    {% endif %}

                    {# Track Birdies #}
                    {% set player_birdies = {} %}

                    {% for game in games %}
                        {% for player_game in game.players %}
                            {% set birdie_holes = [] %}

                            {% for score in player_game.scores %}
                                {% set hole = game.course.holes|sort(attribute='name')|list %}
                                {% if score.hole_number <= hole|length %}
                                    {% set current_hole = hole[score.hole_number - 1] %}
                                    {% if score.strokes == current_hole.par - 1 %}
                                        {% set birdie_holes = birdie_holes + [score.hole_number] %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}

                            {% if player_game.player.name not in player_birdies %}
                                {% set player_birdies = player_birdies | merge({
                                    player_game.player.name: {
                                        'count': birdie_holes|length,
                                        'holes': birdie_holes|sort
                                    }
                                }) %}
                            {% else %}
                                {% set existing_count = player_birdies[player_game.player.name]['count'] %}
                                {% set existing_holes = player_birdies[player_game.player.name]['holes']|list %}
                                {% set player_birdies = player_birdies | merge({
                                    player_game.player.name: {
                                        'count': existing_count + birdie_holes|length,
                                        'holes': (existing_holes + birdie_holes)|sort|unique|list
                                    }
                                }) %}
                            {% endif %}
                        {% endfor %}
                    {% endfor %}

                    {% if player_birdies %}
                        {% set max_birdies = player_birdies.values()|map(attribute='count')|max %}
                        <tr>
                            <td>Birdy Song!</td>
                            <td>The player with the most holes putted with a Birdy (one under par)</td>
                            <td>
                                {% for player_name, data in player_birdies.items() %}
                                    {% if data.count == max_birdies %}
                                        {{ player_name }} ({{ data.count }} birdies)<br>
                                    {% endif %}
                                {% endfor %}
                            </td>
                        </tr>
                    {% endif %}

                    {# Track Eagles #}
                    {% set player_eagles = {} %}

                    {% for game in games %}
                        {% for player_game in game.players %}
                            {% set eagle_holes = [] %}

                            {% for score in player_game.scores %}
                                {% set hole = game.course.holes|sort(attribute='name')|list %}
                                {% if score.hole_number <= hole|length %}
                                    {% set current_hole = hole[score.hole_number - 1] %}
                                    {% if score.strokes == current_hole.par - 2 %}
                                        {% set eagle_holes = eagle_holes + [score.hole_number] %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}

                            {% if player_game.player.name not in player_eagles %}
                                {% set player_eagles = player_eagles | merge({
                                    player_game.player.name: {
                                        'count': eagle_holes|length,
                                        'holes': eagle_holes|sort
                                    }
                                }) %}
                            {% else %}
                                {% set existing_count = player_eagles[player_game.player.name]['count'] %}
                                {% set existing_holes = player_eagles[player_game.player.name]['holes']|list %}
                                {% set player_eagles = player_eagles | merge({
                                    player_game.player.name: {
                                        'count': existing_count + eagle_holes|length,
                                        'holes': (existing_holes + eagle_holes)|sort|unique|list
                                    }
                                }) %}
                            {% endif %}
                        {% endfor %}
                    {% endfor %}

                    {% if player_eagles %}
                        {% set max_eagles = player_eagles.values()|map(attribute='count')|max %}
                        <tr>
                            <td>Eagles Away!</td>
                            <td>The player with the most holes putted with an Eagle (two under par)</td>
                            <td>
                                {% for player_name, data in player_eagles.items() %}
                                    {% if data.count == max_eagles %}
                                        {{ player_name }} ({{ data.count }} eagles)<br>
                                    {% endif %}
                                {% endfor %}
                            </td>
                        </tr>
                    {% endif %}

                    {# Track Albatrosses #}
                    {% set player_albatrosses = {} %}

                    {% for game in games %}
                        {% for player_game in game.players %}
                            {% set albatross_holes = [] %}

                            {% for score in player_game.scores %}
                                {% set hole = game.course.holes|sort(attribute='name')|list %}
                                {% if score.hole_number <= hole|length %}
                                    {% set current_hole = hole[score.hole_number - 1] %}
                                    {% if score.strokes == current_hole.par - 3 %}
                                        {% set albatross_holes = albatross_holes + [score.hole_number] %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}

                            {% if player_game.player.name not in player_albatrosses %}
                                {% set player_albatrosses = player_albatrosses | merge({
                                    player_game.player.name: {
                                        'count': albatross_holes|length,
                                        'holes': albatross_holes|sort
                                    }
                                }) %}
                            {% else %}
                                {% set existing_count = player_albatrosses[player_game.player.name]['count'] %}
                                {% set existing_holes = player_albatrosses[player_game.player.name]['holes']|list %}
                                {% set player_albatrosses = player_albatrosses | merge({
                                    player_game.player.name: {
                                        'count': existing_count + albatross_holes|length,
                                        'holes': (existing_holes + albatross_holes)|sort|unique|list
                                    }
                                }) %}
                            {% endif %}
                        {% endfor %}
                    {% endfor %}

                    {% if player_albatrosses %}
                        {% set max_albatrosses = player_albatrosses.values()|map(attribute='count')|max %}
                        <tr>
                            <td>Uncle Albert</td>
                            <td>The player with the most holes putted with an Albatross (three under par)</td>
                            <td>
                                {% for player_name, data in player_albatrosses.items() %}
                                    {% if data.count == max_albatrosses %}
                                        {{ player_name }} ({{ data.count }} albatrosses)<br>
                                    {% endif %}
                                {% endfor %}
                            </td>
                        </tr>
                    {% endif %}

                    {# Track Condors #}
                    {% set player_condors = {} %}

                    {% for game in games %}
                        {% for player_game in game.players %}
                            {% set condor_holes = [] %}

                            {% for score in player_game.scores %}
                                {% set hole = game.course.holes|sort(attribute='name')|list %}
                                {% if score.hole_number <= hole|length %}
                                    {% set current_hole = hole[score.hole_number - 1] %}
                                    {% if score.strokes == current_hole.par - 4 %}
                                        {% set condor_holes = condor_holes + [score.hole_number] %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}

                            {% if player_game.player.name not in player_condors %}
                                {% set player_condors = player_condors | merge({
                                    player_game.player.name: {
                                        'count': condor_holes|length,
                                        'holes': condor_holes|sort
                                    }
                                }) %}
                            {% else %}
                                {% set existing_count = player_condors[player_game.player.name]['count'] %}
                                {% set existing_holes = player_condors[player_game.player.name]['holes']|list %}
                                {% set player_condors = player_condors | merge({
                                    player_game.player.name: {
                                        'count': existing_count + condor_holes|length,
                                        'holes': (existing_holes + condor_holes)|sort|unique|list
                                    }
                                }) %}
                            {% endif %}
                        {% endfor %}
                    {% endfor %}

                    {% if player_condors %}
                        {% set max_condors = player_condors.values()|map(attribute='count')|max %}
                        <tr>
                            <td>Ah Condor...</td>
                            <td>The player with the most holes putted with a Condor (four under par)</td>
                            <td>
                                {% for player_name, data in player_condors.items() %}
                                    {% if data.count == max_condors %}
                                        {{ player_name }} ({{ data.count }} condors)<br>
                                    {% endif %}
                                {% endfor %}
                            </td>
                        </tr>
                    {% endif %}

                    {# Track Maximum Strokes on a Single Hole #}
                    {% set player_max_strokes = {} %}

                    {% for game in games %}
                        {% for player_game in game.players %}
                            {% set max_stroke_hole = {'strokes': 0, 'hole': 0} %}

                            {% for score in player_game.scores %}
                                {% if score.strokes > max_stroke_hole.strokes %}
                                    {% set max_stroke_hole = {
                                        'strokes': score.strokes,
                                        'hole': score.hole_number
                                    } %}
                                {% endif %}
                            {% endfor %}

                            {% if player_game.player.name not in player_max_strokes %}
                                {% set player_max_strokes = player_max_strokes | merge({
                                    player_game.player.name: max_stroke_hole
                                }) %}
                            {% else %}
                                {% if max_stroke_hole.strokes > player_max_strokes[player_game.player.name].strokes %}
                                    {% set player_max_strokes = player_max_strokes | merge({
                                        player_game.player.name: max_stroke_hole
                                    }) %}
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                    {% endfor %}

                    {% if player_max_strokes %}
                        {% set overall_max_strokes = player_max_strokes.values()|map(attribute='strokes')|max %}
                        <tr>
                            <td>Mr Bean</td>
                            <td>The player with the most strokes on a single hole</td>
                            <td>
                                {% for player_name, data in player_max_strokes.items() %}
                                    {% if data.strokes == overall_max_strokes %}
                                        {{ player_name }} ({{ data.strokes }} putts on hole {{ data.hole }})<br>
                                    {% endif %}
                                {% endfor %}
                            </td>
                        </tr>
                    {% endif %}

                    {# Track Under Par Holes #}
                    {% set player_under_par = {} %}

                    {% for game in games %}
                        {% for player_game in game.players %}
                            {% set under_par_holes = [] %}

                            {% for score in player_game.scores %}
                                {% set hole = game.course.holes|sort(attribute='name')|list %}
                                {% if score.hole_number <= hole|length %}
                                    {% set current_hole = hole[score.hole_number - 1] %}
                                    {% if score.strokes < current_hole.par %}
                                        {% set under_par_holes = under_par_holes + [score.hole_number] %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}

                            {% if player_game.player.name not in player_under_par %}
                                {% set player_under_par = player_under_par | merge({
                                    player_game.player.name: {
                                        'count': under_par_holes|length,
                                        'holes': under_par_holes|sort
                                    }
                                }) %}
                            {% else %}
                                {% set existing_count = player_under_par[player_game.player.name]['count'] %}
                                {% set existing_holes = player_under_par[player_game.player.name]['holes']|list %}
                                {% set player_under_par = player_under_par | merge({
                                    player_game.player.name: {
                                        'count': existing_count + under_par_holes|length,
                                        'holes': (existing_holes + under_par_holes)|sort|unique|list
                                    }
                                }) %}
                            {% endif %}
                        {% endfor %}
                    {% endfor %}

                    {% if player_under_par %}
                        {% set max_under_par = player_under_par.values()|map(attribute='count')|max %}
                        <tr>
                            <td>Under Par</td>
                            <td>The player with the most holes played under par</td>
                            <td>
                                {% for player_name, data in player_under_par.items() %}
                                    {% if data.count == max_under_par %}
                                        {{ player_name }} ({{ data.count }} holes under par)<br>
                                    {% endif %}
                                {% endfor %}
                            </td>
                        </tr>
                    {% endif %}

                    {# Track Leading But Not Winning - Simplified Version #}
                    {% set overall_leader_name = '' %}
                    {% set overall_leader_holes = 0 %}
                    {% set overall_leader_game = '' %}

                    {% for game in games %}
                        {# Find the winner of this game first #}
                        {% set winner_name = '' %}
                        {% set lowest_score = 999999 %}

                        {% for player_game in game.players %}
                            {% set total = player_game.scores|map(attribute='strokes')|sum %}
                            {% if total < lowest_score %}
                                {% set lowest_score = total %}
                                {% set winner_name = player_game.player.name %}
                            {% endif %}
                        {% endfor %}

                        {# Track leading players for this game #}
                        {% set holes_completed = game.players[0].scores|length %}
                        {% set current_leader_holes = 0 %}
                        {% set current_leader_name = '' %}

                        {% for hole in range(1, holes_completed + 1) %}
                            {% set hole_scores = [] %}
                            {% set min_score = 999999 %}
                            {% set current_hole_leader = '' %}

                            {# Calculate cumulative scores up to this hole #}
                            {% for player_game in game.players %}
                                {% set running_total = 0 %}
                                {% for score in player_game.scores|sort(attribute='hole_number') %}
                                    {% if score.hole_number <= hole %}
                                        {% set running_total = running_total + score.strokes %}
                                    {% endif %}
                                {% endfor %}
                                {% if running_total < min_score %}
                                    {% set min_score = running_total %}
                                    {% set current_hole_leader = player_game.player.name %}
                                {% endif %}
                            {% endfor %}

                            {# Update hole count for the leader #}
                            {% if current_hole_leader and current_hole_leader != winner_name %}
                                {% if current_hole_leader == current_leader_name %}
                                    {% set current_leader_holes = current_leader_holes + 1 %}
                                {% else %}
                                    {% set current_leader_name = current_hole_leader %}
                                    {% set current_leader_holes = 1 %}
                                {% endif %}
                            {% endif %}
                        {% endfor %}

                        {# Update overall leader if this game's leader led for more holes #}
                        {% if current_leader_holes > overall_leader_holes and current_leader_name != winner_name %}
                            {% set overall_leader_holes = current_leader_holes %}
                            {% set overall_leader_name = current_leader_name %}
                            {% set overall_leader_game = game.game_code %}
                        {% endif %}
                    {% endfor %}

                    {% if overall_leader_holes > 0 %}
                        <tr>
                            <td>A Little Premature!</td>
                            <td>The player who led the game the longest but didn't win</td>
                            <td>
                                {{ overall_leader_name }}
                                (led for {{ overall_leader_holes }} holes in game {{ overall_leader_game }})
                            </td>
                        </tr>
                    {% endif %}

                </tbody>
            </table>
        </div>

        {% else %}
        <p>{{ get_localized_text('NoGamesPlayed', 'No games have been played yet.') }}</p>
        {% endif %}
    </div>
</div>
{% endblock %}