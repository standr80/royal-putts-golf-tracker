{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <h2 class="mb-4">Enter Game Scores</h2>

        <div class="alert alert-success mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="alert-heading mb-2">Game Code: <strong>{{ game.game_code }}</strong></h4>
                    <p class="mb-0">Share this code with other players to let them find this game.</p>
                </div>
                <div class="d-flex gap-2">
                    <button id="copy-game-code" 
                            class="btn btn-light" 
                            data-game-code="{{ game.game_code }}">
                        <i data-feather="copy"></i> Copy Code
                    </button>
                </div>
            </div>
        </div>

        <div class="card bg-dark mb-4">
            <div class="card-body">
                <h5 class="card-title mb-4">Hole {{ current_hole }}</h5>

                <form method="POST" class="needs-validation" novalidate>
                    <input type="hidden" name="current_hole" value="{{ current_hole }}">

                    <div class="table-responsive">
                        <table class="table table-dark">
                            <thead>
                                <tr>
                                    <th>Score</th>
                                    <th>Player</th>
                                    <th>Strokes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for player_game in game.players %}
                                    {% set cumulative_score = 0 %}
                                    {% for score in player_game.scores %}
                                        {% if score.hole_number <= current_hole %}
                                            {% set cumulative_score = cumulative_score + score.strokes %}
                                        {% endif %}
                                    {% endfor %}
                                    <tr>
                                        <td>{{ cumulative_score }}</td>
                                        <td>{{ player_game.player.name }}</td>
                                        <td>
                                            {% set current_score = none %}
                                            {% for score in player_game.scores %}
                                                {% if score.hole_number == current_hole %}
                                                    {% set current_score = score %}
                                                {% endif %}
                                            {% endfor %}
                                            <input type="number" 
                                                   class="form-control score-input" 
                                                   name="scores_{{ player_game.id }}_{{ current_hole }}"
                                                   min="1" 
                                                   max="20"
                                                   value="{{ current_score.strokes if current_score else '' }}"
                                                   required>
                                            <div class="invalid-feedback">
                                                Valid score: 1-20
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <div class="d-flex justify-content-between mt-4">
                        {% if current_hole > 1 %}
                        <a href="{{ url_for('scoring', game_code=game.game_code, hole=current_hole-1) }}" 
                           class="btn btn-secondary">
                            <i data-feather="arrow-left"></i> Previous Hole
                        </a>
                        {% else %}
                        <div></div>
                        {% endif %}

                        {% if current_hole < 18 %}
                        <button type="submit" class="btn btn-primary">
                            Next Hole <i data-feather="arrow-right"></i>
                        </button>
                        {% else %}
                        <button type="submit" class="btn btn-success">
                            <i data-feather="save"></i> Finish Game
                        </button>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Copy game code functionality
    const copyGameCodeBtn = document.getElementById('copy-game-code');
    if (copyGameCodeBtn) {
        copyGameCodeBtn.addEventListener('click', function() {
            const gameCode = this.getAttribute('data-game-code');
            navigator.clipboard.writeText(gameCode).then(() => {
                const originalText = this.innerHTML;
                this.innerHTML = '<i data-feather="check"></i> Copied!';
                feather.replace();
                setTimeout(() => {
                    this.innerHTML = originalText;
                    feather.replace();
                }, 2000);
            });
        });
    }

    // Form validation
    const form = document.querySelector('form');
    form.addEventListener('submit', function(event) {
        if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
        }
        form.classList.add('was-validated');
    });

    feather.replace();
});
</script>
{% endblock %}