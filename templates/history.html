{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-10 mx-auto">
        <h2 class="mb-4">
            {{ get_localized_text('GameResultsTable', 'Game Results') }}
        </h2>

        {% if games %}
        <div class="table-responsive">
            <table class="table table-dark table-hover">
                <thead>
                    <tr>
                        <th>{{ get_localized_text('GameResultsTableGameCode', 'Game Code') }}</th>
                        <th>{{ get_localized_text('GameResultsTablePlayers', 'Players') }}</th>
                        <th>{{ get_localized_text('GameResultsTablePutts', 'Total Putts') }}</th>
                        <th>{{ get_localized_text('GameResultsTableRank', 'Ranking') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for game in games %}
                    <tr>
                        <td><code class="bg-dark">{{ game.game_code }}</code></td>
                        <td>
                            {% for player_game in game.players %}
                            <div>{{ player_game.player.name }}</div>
                            {% endfor %}
                        </td>
                        <td>
                            {% for player_game in game.players %}
                            <div>{{ player_game.total_score }}</div>
                            {% endfor %}
                        </td>
                        <td>
                            {% set sorted_players = game.players|sort(attribute='total_score') %}
                            {% for player_game in sorted_players %}
                            <div>
                                {{ loop.index }}: {{ player_game.player.name }}
                            </div>
                            {% endfor %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Outstanding Achievements Section -->
        <h3 class="mt-5 mb-4">{{ get_localized_text('OutstandingAchievementsTableTitle', 'Outstanding Achievements') }}</h3>
        <div class="table-responsive">
            <table class="table table-dark table-hover">
                <thead>
                    <tr>
                        <th>{{ get_localized_text('OutstandingAchievementsTableCol1', 'Achievement') }}</th>
                        <th>{{ get_localized_text('OutstandingAchievementsTableCol2', 'Player') }}</th>
                        <th>{{ get_localized_text('OutstandingAchievementsTableCol3', 'Details') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% set all_achievements = {
                        'holes_in_one': {},
                        'birdies': {},
                        'eagles': {},
                        'albatrosses': {},
                        'condors': {},
                        'holes_in_par': {}
                    } %}

                    {% for game in games %}
                        {% for player_game in game.players %}
                            {% set achievements = {
                                'holes_in_one': [],
                                'birdies': [],
                                'eagles': [],
                                'albatrosses': [],
                                'condors': [],
                                'holes_in_par': []
                            } %}

                            {% for score in player_game.scores %}
                                {% set hole = game.course.holes|sort(attribute='name')|list %}
                                {% if score.hole_number <= hole|length %}
                                    {% set current_hole = hole[score.hole_number - 1] %}

                                    {% if score.strokes == 1 %}
                                        {% set _ = achievements.holes_in_one.append(score.hole_number) %}
                                    {% endif %}

                                    {% if score.strokes == current_hole.par - 1 %}
                                        {% set _ = achievements.birdies.append(score.hole_number) %}
                                    {% endif %}

                                    {% if score.strokes == current_hole.par - 2 %}
                                        {% set _ = achievements.eagles.append(score.hole_number) %}
                                    {% endif %}

                                    {% if score.strokes == current_hole.par - 3 %}
                                        {% set _ = achievements.albatrosses.append(score.hole_number) %}
                                    {% endif %}

                                    {% if score.strokes == current_hole.par - 4 %}
                                        {% set _ = achievements.condors.append(score.hole_number) %}
                                    {% endif %}

                                    {% if score.strokes == current_hole.par %}
                                        {% set _ = achievements.holes_in_par.append(score.hole_number) %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}

                            {% if achievements.holes_in_one %}
                                {% set _ = all_achievements.holes_in_one.update({
                                    player_game.player.name: {
                                        'count': achievements.holes_in_one|length,
                                        'holes': achievements.holes_in_one|sort
                                    }
                                }) %}
                            {% endif %}

                            {% if achievements.birdies %}
                                {% set _ = all_achievements.birdies.update({
                                    player_game.player.name: {
                                        'count': achievements.birdies|length,
                                        'holes': achievements.birdies|sort
                                    }
                                }) %}
                            {% endif %}

                            {% if achievements.eagles %}
                                {% set _ = all_achievements.eagles.update({
                                    player_game.player.name: {
                                        'count': achievements.eagles|length,
                                        'holes': achievements.eagles|sort
                                    }
                                }) %}
                            {% endif %}

                            {% if achievements.albatrosses %}
                                {% set _ = all_achievements.albatrosses.update({
                                    player_game.player.name: {
                                        'count': achievements.albatrosses|length,
                                        'holes': achievements.albatrosses|sort
                                    }
                                }) %}
                            {% endif %}

                            {% if achievements.condors %}
                                {% set _ = all_achievements.condors.update({
                                    player_game.player.name: {
                                        'count': achievements.condors|length,
                                        'holes': achievements.condors|sort
                                    }
                                }) %}
                            {% endif %}

                            {% if achievements.holes_in_par %}
                                {% set _ = all_achievements.holes_in_par.update({
                                    player_game.player.name: {
                                        'count': achievements.holes_in_par|length,
                                        'holes': achievements.holes_in_par|sort
                                    }
                                }) %}
                            {% endif %}
                        {% endfor %}
                    {% endfor %}

                    {% if all_achievements.holes_in_one %}
                        {% set max_holes_in_one = all_achievements.holes_in_one.values()|map(attribute='count')|max %}
                        {% for player_name, data in all_achievements.holes_in_one.items() %}
                            {% if data.count == max_holes_in_one %}
                                <tr>
                                    <td>Most Holes in One</td>
                                    <td>{{ player_name }}</td>
                                    <td>{{ player_name }} scored {{ data.count }} holes in one on holes {{ data.holes|join(', ') }}!</td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                    {% endif %}

                    {% if all_achievements.birdies %}
                        {% set max_birdies = all_achievements.birdies.values()|map(attribute='count')|max %}
                        {% for player_name, data in all_achievements.birdies.items() %}
                            {% if data.count == max_birdies %}
                                <tr>
                                    <td>Most Birdies</td>
                                    <td>{{ player_name }}</td>
                                    <td>{{ player_name }} scored {{ data.count }} birdies on holes {{ data.holes|join(', ') }}!</td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                    {% endif %}

                    {% if all_achievements.eagles %}
                        {% set max_eagles = all_achievements.eagles.values()|map(attribute='count')|max %}
                        {% for player_name, data in all_achievements.eagles.items() %}
                            {% if data.count == max_eagles %}
                                <tr>
                                    <td>Most Eagles</td>
                                    <td>{{ player_name }}</td>
                                    <td>{{ player_name }} scored {{ data.count }} eagles on holes {{ data.holes|join(', ') }}!</td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                    {% endif %}

                    {% if all_achievements.albatrosses %}
                        {% set max_albatrosses = all_achievements.albatrosses.values()|map(attribute='count')|max %}
                        {% for player_name, data in all_achievements.albatrosses.items() %}
                            {% if data.count == max_albatrosses %}
                                <tr>
                                    <td>Most Albatrosses</td>
                                    <td>{{ player_name }}</td>
                                    <td>{{ player_name }} scored {{ data.count }} albatrosses on holes {{ data.holes|join(', ') }}!</td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                    {% endif %}

                    {% if all_achievements.condors %}
                        {% set max_condors = all_achievements.condors.values()|map(attribute='count')|max %}
                        {% for player_name, data in all_achievements.condors.items() %}
                            {% if data.count == max_condors %}
                                <tr>
                                    <td>Most Condors</td>
                                    <td>{{ player_name }}</td>
                                    <td>{{ player_name }} scored {{ data.count }} condors on holes {{ data.holes|join(', ') }}!</td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                    {% endif %}

                    {% if all_achievements.holes_in_par %}
                        {% set max_holes_in_par = all_achievements.holes_in_par.values()|map(attribute='count')|max %}
                        {% for player_name, data in all_achievements.holes_in_par.items() %}
                            {% if data.count == max_holes_in_par %}
                                <tr>
                                    <td>Most Holes in Par</td>
                                    <td>{{ player_name }}</td>
                                    <td>{{ player_name }} scored {{ data.count }} holes in par on holes {{ data.holes|join(', ') }}!</td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                </tbody>
            </table>
        </div>

        <!-- Player Stats - the Highs and Lows Section -->
        <h3 class="mt-5 mb-4">Player Stats - the Highs and Lows!</h3>
        <div class="table-responsive">
            <table class="table table-dark table-hover">
                <thead>
                    <tr>
                        <th>Stat</th>
                        <th>Description</th>
                        <th>Player</th>
                    </tr>
                </thead>
                <tbody>
                    {% set player_over_par_counts = {} %}

                    {% for game in games %}
                        {% for player_game in game.players %}
                            {% set over_par_holes = [] %}

                            {% for score in player_game.scores %}
                                {% set hole = game.course.holes|sort(attribute='name')|list %}
                                {% if score.hole_number <= hole|length %}
                                    {% set current_hole = hole[score.hole_number - 1] %}
                                    {% if score.strokes > current_hole.par %}
                                        {% set _ = over_par_holes.append(score.hole_number) %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}

                            {% if player_game.player.name not in player_over_par_counts %}
                                {% set _ = player_over_par_counts.update({
                                    player_game.player.name: {
                                        'count': over_par_holes|length,
                                        'holes': over_par_holes|sort
                                    }
                                }) %}
                            {% else %}
                                {% set existing_count = player_over_par_counts[player_game.player.name]['count'] %}
                                {% set existing_holes = player_over_par_counts[player_game.player.name]['holes']|list %}
                                {% set _ = player_over_par_counts.update({
                                    player_game.player.name: {
                                        'count': existing_count + over_par_holes|length,
                                        'holes': (existing_holes + over_par_holes)|sort|unique|list
                                    }
                                }) %}
                            {% endif %}
                        {% endfor %}
                    {% endfor %}

                    {% if player_over_par_counts %}
                        {% set max_over_par = player_over_par_counts.values()|map(attribute='count')|max %}
                        <tr>
                            <td>The Bogey Master</td>
                            <td>The player with the most holes played over par</td>
                            <td>
                                {% for player_name, data in player_over_par_counts.items() %}
                                    {% if data.count == max_over_par %}
                                        {{ player_name }} ({{ data.count }} holes over par)<br>
                                    {% endif %}
                                {% endfor %}
                            </td>
                        </tr>
                    {% endif %}

                    {# Track Holes in One #}
                    {% set player_aces = {} %}

                    {% for game in games %}
                        {% for player_game in game.players %}
                            {% set ace_holes = [] %}

                            {% for score in player_game.scores %}
                                {% if score.strokes == 1 %}
                                    {% set _ = ace_holes.append(score.hole_number) %}
                                {% endif %}
                            {% endfor %}

                            {% if player_game.player.name not in player_aces %}
                                {% set _ = player_aces.update({
                                    player_game.player.name: {
                                        'count': ace_holes|length,
                                        'holes': ace_holes|sort
                                    }
                                }) %}
                            {% else %}
                                {% set existing_count = player_aces[player_game.player.name]['count'] %}
                                {% set existing_holes = player_aces[player_game.player.name]['holes']|list %}
                                {% set _ = player_aces.update({
                                    player_game.player.name: {
                                        'count': existing_count + ace_holes|length,
                                        'holes': (existing_holes + ace_holes)|sort|unique|list
                                    }
                                }) %}
                            {% endif %}
                        {% endfor %}
                    {% endfor %}

                    {% if player_aces %}
                        {% set max_aces = player_aces.values()|map(attribute='count')|max %}
                        <tr>
                            <td>The ACE!</td>
                            <td>The player with the most holes in one</td>
                            <td>
                                {% for player_name, data in player_aces.items() %}
                                    {% if data.count == max_aces %}
                                        {{ player_name }} ({{ data.count }} holes in one)<br>
                                    {% endif %}
                                {% endfor %}
                            </td>
                        </tr>
                    {% endif %}

                    {# Track Holes in Par #}
                    {% set player_pars = {} %}

                    {% for game in games %}
                        {% for player_game in game.players %}
                            {% set par_holes = [] %}

                            {% for score in player_game.scores %}
                                {% set hole = game.course.holes|sort(attribute='name')|list %}
                                {% if score.hole_number <= hole|length %}
                                    {% set current_hole = hole[score.hole_number - 1] %}
                                    {% if score.strokes == current_hole.par %}
                                        {% set _ = par_holes.append(score.hole_number) %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}

                            {% if player_game.player.name not in player_pars %}
                                {% set _ = player_pars.update({
                                    player_game.player.name: {
                                        'count': par_holes|length,
                                        'holes': par_holes|sort
                                    }
                                }) %}
                            {% else %}
                                {% set existing_count = player_pars[player_game.player.name]['count'] %}
                                {% set existing_holes = player_pars[player_game.player.name]['holes']|list %}
                                {% set _ = player_pars.update({
                                    player_game.player.name: {
                                        'count': existing_count + par_holes|length,
                                        'holes': (existing_holes + par_holes)|sort|unique|list
                                    }
                                }) %}
                            {% endif %}
                        {% endfor %}
                    {% endfor %}

                    {% if player_pars %}
                        {% set max_pars = player_pars.values()|map(attribute='count')|max %}
                        <tr>
                            <td>Par-boiled!</td>
                            <td>The player with the most holes putted in par</td>
                            <td>
                                {% for player_name, data in player_pars.items() %}
                                    {% if data.count == max_pars %}
                                        {{ player_name }} ({{ data.count }} holes in par)<br>
                                    {% endif %}
                                {% endfor %}
                            </td>
                        </tr>
                    {% endif %}

                    {# Track Birdies #}
                    {% set player_birdies = {} %}

                    {% for game in games %}
                        {% for player_game in game.players %}
                            {% set birdie_holes = [] %}

                            {% for score in player_game.scores %}
                                {% set hole = game.course.holes|sort(attribute='name')|list %}
                                {% if score.hole_number <= hole|length %}
                                    {% set current_hole = hole[score.hole_number - 1] %}
                                    {% if score.strokes == current_hole.par - 1 %}
                                        {% set _ = birdie_holes.append(score.hole_number) %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}

                            {% if player_game.player.name not in player_birdies %}
                                {% set _ = player_birdies.update({
                                    player_game.player.name: {
                                        'count': birdie_holes|length,
                                        'holes': birdie_holes|sort
                                    }
                                }) %}
                            {% else %}
                                {% set existing_count = player_birdies[player_game.player.name]['count'] %}
                                {% set existing_holes = player_birdies[player_game.player.name]['holes']|list %}
                                {% set _ = player_birdies.update({
                                    player_game.player.name: {
                                        'count': existing_count + birdie_holes|length,
                                        'holes': (existing_holes + birdie_holes)|sort|unique|list
                                    }
                                }) %}
                            {% endif %}
                        {% endfor %}
                    {% endfor %}

                    {% if player_birdies %}
                        {% set max_birdies = player_birdies.values()|map(attribute='count')|max %}
                        <tr>
                            <td>Birdy Song!</td>
                            <td>The player with the most holes putted with a Birdy (one under par)</td>
                            <td>
                                {% for player_name, data in player_birdies.items() %}
                                    {% if data.count == max_birdies %}
                                        {{ player_name }} ({{ data.count }} birdies)<br>
                                    {% endif %}
                                {% endfor %}
                            </td>
                        </tr>
                    {% endif %}

                    {# Track Eagles #}
                    {% set player_eagles = {} %}

                    {% for game in games %}
                        {% for player_game in game.players %}
                            {% set eagle_holes = [] %}

                            {% for score in player_game.scores %}
                                {% set hole = game.course.holes|sort(attribute='name')|list %}
                                {% if score.hole_number <= hole|length %}
                                    {% set current_hole = hole[score.hole_number - 1] %}
                                    {% if score.strokes == current_hole.par - 2 %}
                                        {% set _ = eagle_holes.append(score.hole_number) %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}

                            {% if player_game.player.name not in player_eagles %}
                                {% set _ = player_eagles.update({
                                    player_game.player.name: {
                                        'count': eagle_holes|length,
                                        'holes': eagle_holes|sort
                                    }
                                }) %}
                            {% else %}
                                {% set existing_count = player_eagles[player_game.player.name]['count'] %}
                                {% set existing_holes = player_eagles[player_game.player.name]['holes']|list %}
                                {% set _ = player_eagles.update({
                                    player_game.player.name: {
                                        'count': existing_count + eagle_holes|length,
                                        'holes': (existing_holes + eagle_holes)|sort|unique|list
                                    }
                                }) %}
                            {% endif %}
                        {% endfor %}
                    {% endfor %}

                    {% if player_eagles %}
                        {% set max_eagles = player_eagles.values()|map(attribute='count')|max %}
                        <tr>
                            <td>Eagles Away!</td>
                            <td>The player with the most holes putted with an Eagle (two under par)</td>
                            <td>
                                {% for player_name, data in player_eagles.items() %}
                                    {% if data.count == max_eagles %}
                                        {{ player_name }} ({{ data.count }} eagles)<br>
                                    {% endif %}
                                {% endfor %}
                            </td>
                        </tr>
                    {% endif %}

                    {# Track Albatrosses #}
                    {% set player_albatrosses = {} %}

                    {% for game in games %}
                        {% for player_game in game.players %}
                            {% set albatross_holes = [] %}

                            {% for score in player_game.scores %}
                                {% set hole = game.course.holes|sort(attribute='name')|list %}
                                {% if score.hole_number <= hole|length %}
                                    {% set current_hole = hole[score.hole_number - 1] %}
                                    {% if score.strokes == current_hole.par - 3 %}
                                        {% set _ = albatross_holes.append(score.hole_number) %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}

                            {% if player_game.player.name not in player_albatrosses %}
                                {% set _ = player_albatrosses.update({
                                    player_game.player.name: {
                                        'count': albatross_holes|length,
                                        'holes': albatross_holes|sort
                                    }
                                }) %}
                            {% else %}
                                {% set existing_count = player_albatrosses[player_game.player.name]['count'] %}
                                {% set existing_holes = player_albatrosses[player_game.player.name]['holes']|list %}
                                {% set _ = player_albatrosses.update({
                                    player_game.player.name: {
                                        'count': existing_count + albatross_holes|length,
                                        'holes': (existing_holes + albatross_holes)|sort|unique|list
                                    }
                                }) %}
                            {% endif %}
                        {% endfor %}
                    {% endfor %}

                    {% if player_albatrosses %}
                        {% set max_albatrosses = player_albatrosses.values()|map(attribute='count')|max %}
                        <tr>
                            <td>Uncle Albert</td>
                            <td>The player with the most holes putted with an Albatross (three under par)</td>
                            <td>
                                {% for player_name, data in player_albatrosses.items() %}
                                    {% if data.count == max_albatrosses %}
                                        {{ player_name }} ({{ data.count }} albatrosses)<br>
                                    {% endif %}
                                {% endfor %}
                            </td>
                        </tr>
                    {% endif %}

                    {# Track Condors #}
                    {% set player_condors = {} %}

                    {% for game in games %}
                        {% for player_game in game.players %}
                            {% set condor_holes = [] %}

                            {% for score in player_game.scores %}
                                {% set hole = game.course.holes|sort(attribute='name')|list %}
                                {% if score.hole_number <= hole|length %}
                                    {% set current_hole = hole[score.hole_number - 1] %}
                                    {% if score.strokes == current_hole.par - 4 %}
                                        {% set _ = condor_holes.append(score.hole_number) %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}

                            {% if player_game.player.name not in player_condors %}
                                {% set _ = player_condors.update({
                                    player_game.player.name: {
                                        'count': condor_holes|length,
                                        'holes': condor_holes|sort
                                    }
                                }) %}
                            {% else %}
                                {% set existing_count = player_condors[player_game.player.name]['count'] %}
                                {% set existing_holes = player_condors[player_game.player.name]['holes']|list %}
                                {% set _ = player_condors.update({
                                    player_game.player.name: {
                                        'count': existing_count + condor_holes|length,
                                        'holes': (existing_holes + condor_holes)|sort|unique|list
                                    }
                                }) %}
                            {% endif %}
                        {% endfor %}
                    {% endfor %}

                    {% if player_condors %}
                        {% set max_condors = player_condors.values()|map(attribute='count')|max %}
                        <tr>
                            <td>Ah Condor...</td>
                            <td>The player with the most holes putted with a Condor (four under par)</td>
                            <td>
                                {% for player_name, data in player_condors.items() %}
                                    {% if data.count == max_condors %}
                                        {{ player_name }} ({{ data.count }} condors)<br>
                                    {% endif %}
                                {% endfor %}
                            </td>
                        </tr>
                    {% endif %}

                    {# Track Maximum Strokes on a Single Hole #}
                    {% set player_max_strokes = {} %}

                    {% for game in games %}
                        {% for player_game in game.players %}
                            {% set max_stroke_hole = {'strokes': 0, 'hole': 0} %}

                            {% for score in player_game.scores %}
                                {% if score.strokes > max_stroke_hole.strokes %}
                                    {% set _ = max_stroke_hole.update({
                                        'strokes': score.strokes,
                                        'hole': score.hole_number
                                    }) %}
                                {% endif %}
                            {% endfor %}

                            {% if player_game.player.name not in player_max_strokes %}
                                {% set _ = player_max_strokes.update({
                                    player_game.player.name: max_stroke_hole
                                }) %}
                            {% else %}
                                {% if max_stroke_hole.strokes > player_max_strokes[player_game.player.name].strokes %}
                                    {% set _ = player_max_strokes.update({
                                        player_game.player.name: max_stroke_hole
                                    }) %}
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                    {% endfor %}

                    {% if player_max_strokes %}
                        {% set overall_max_strokes = player_max_strokes.values()|map(attribute='strokes')|max %}
                        <tr>
                            <td>Mr Bean</td>
                            <td>The player with the most strokes on a single hole</td>
                            <td>
                                {% for player_name, data in player_max_strokes.items() %}
                                    {% if data.strokes == overall_max_strokes %}
                                        {{ player_name }} ({{ data.strokes }} putts on hole {{ data.hole }})<br>
                                    {% endif %}
                                {% endfor %}
                            </td>
                        </tr>
                    {% endif %}

                    {# Track Under Par Holes #}
                    {% set player_under_par = {} %}

                    {% for game in games %}
                        {% for player_game in game.players %}
                            {% set under_par_holes = [] %}

                            {% for score in player_game.scores %}
                                {% set hole = game.course.holes|sort(attribute='name')|list %}
                                {% if score.hole_number <= hole|length %}
                                    {% set current_hole = hole[score.hole_number - 1] %}
                                    {% if score.strokes < current_hole.par %}
                                        {% set _ = under_par_holes.append(score.hole_number) %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}

                            {% if player_game.player.name not in player_under_par %}
                                {% set _ = player_under_par.update({
                                    player_game.player.name: {
                                        'count': under_par_holes|length,
                                        'holes': under_par_holes|sort
                                    }
                                }) %}
                            {% else %}
                                {% set existing_count = player_under_par[player_game.player.name]['count'] %}
                                {% set existing_holes = player_under_par[player_game.player.name]['holes']|list %}
                                {% set _ = player_under_par.update({
                                    player_game.player.name: {
                                        'count': existing_count + under_par_holes|length,
                                        'holes': (existing_holes + under_par_holes)|sort|unique|list
                                    }
                                }) %}
                            {% endif %}
                        {% endfor %}
                    {% endfor %}

                    {% if player_under_par %}
                        {% set max_under_par = player_under_par.values()|map(attribute='count')|max %}
                        <tr>
                            <td>Under Par</td>
                            <td>The player with the most holes played under par</td>
                            <td>
                                {% for player_name, data in player_under_par.items() %}
                                    {% if data.count == max_under_par %}
                                        {{ player_name }} ({{ data.count }} holes under par)<br>
                                    {% endif %}
                                {% endfor %}
                            </td>
                        </tr>
                    {% endif %}

                    {# Track Leading But Not Winning #}
                    {% set premature_leader_stats = None %}
                    {% for game in games %}
                        {% set leading_players = {} %}
                        {% set final_winner = None %}

                        {# First determine the winner #}
                        {% for player_game in game.players %}
                            {% set total_putts = player_game.scores|map(attribute='strokes')|sum %}
                            {% if not final_winner or total_putts < final_winner.total_putts %}
                                {% set final_winner = {'name': player_game.player.name, 'total_putts': total_putts} %}
                            {% endif %}
                        {% endfor %}

                        {# For each hole, track who was leading #}
                        {% for hole in range(1, 19) %}  {# Max 18 holes in golf #}
                            {% set hole_totals = [] %}

                            {# Get cumulative scores up to this hole #}
                            {% for player_game in game.players %}
                                {% set cumulative = {'player': player_game.player.name, 'total': 0} %}
                                {% for score in player_game.scores|sort(attribute='hole_number') %}
                                    {% if score.hole_number <= hole %}
                                        {% set cumulative = cumulative|update({'total': cumulative.total + score.strokes}) %}
                                    {% endif %}
                                {% endfor %}
                                {% if player_game.scores|selectattr('hole_number', 'le', hole)|list|length == hole %}
                                    {% set _ = hole_totals.append(cumulative) %}
                                {% endif %}
                            {% endfor %}

                            {# If all players have scores for this hole, determine leader #}
                            {% if hole_totals|length == game.players|length %}
                                {% set min_score = hole_totals|map(attribute='total')|min %}
                                {% for score in hole_totals %}
                                    {% if score.total == min_score %}
                                        {% if score.player not in leading_players %}
                                            {% set _ = leading_players.update({score.player: 1}) %}
                                        {% else %}
                                            {% set _ = leading_players.update({
                                                score.player: leading_players[score.player] + 1
                                            }) %}
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        {% endfor %}

                        {# Record the player who led most but didn't win #}
                        {% for player, holes_led in leading_players.items() %}
                            {% if player != final_winner.name %}
                                {% if not premature_leader_stats or holes_led > premature_leader_stats.holes_led %}
                                    {% set premature_leader_stats = {
                                        'name': player,
                                        'holes_led': holes_led,
                                        'game_code': game.game_code
                                    } %}
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                    {% endfor %}

                    {% if premature_leader_stats %}
                        <tr>
                            <td>A Little Premature!</td>
                            <td>The player who led the game the longest but didn't win</td>
                            <td>
                                {{ premature_leader_stats.name }} 
                                (led for {{ premature_leader_stats.holes_led }} holes in game {{ premature_leader_stats.game_code }})
                            </td>
                        </tr>
                    {% endif %}

                </tbody>
            </table>
        </div>

        {% else %}
        <p>{{ get_localized_text('NoGamesPlayed', 'No games have been played yet.') }}</p>
        {% endif %}
    </div></div>
{% endblock %}